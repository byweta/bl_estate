<!DOCTYPE html>
<html>
	<head>
		<!-- author：王朝贤 / createTime：2020年2月28日 -->
		<meta charset="utf-8">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0" />
		<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
		<title>社区管理</title>
		<!-- 引入 jquery-weui -->
		<link rel="stylesheet" type="text/css" href="../css/weui/weui.css" />
		<link rel="stylesheet" type="text/css" href="../css/jqweui/jquery-weui.css">
		<link rel="stylesheet" type="text/css" href="../css/home.css?v=2" />
		<link rel="stylesheet" type="text/css" href="../css/swiper.min.css" />
		<link rel="stylesheet" type="text/css" href="../css/iosSelect.css">
		<style type="text/css">
			body,
			html {
				height: 100%;
				margin: 0;
				padding: 0;
				-webkit-tap-highlight-color: transparent;
				background-color: #F7F7F7;
			}

			/* 超出单行显示省略号 */
			.line_ellipsis {
				white-space: nowrap;
				overflow: hidden;
				text-overflow: ellipsis;
			}

			/* 分割线 */
			.split_line {
				height: 10px;
				background-color: #F8F8F8;
			}
			
			.back_home {
				position: absolute;
				top: 10px;
				right: 15px;
				width: 30px;
				height: 30px;
				line-height: 30px;
				font-size: 14px;
				font-weight: 700;
				color: #00A0E9;
				background: url(../img/home_page/icon_back_home.png) center right no-repeat;
				background-size: 24px;
			}
		</style>
	</head>
	<body ontouchstart>
		<div class="container" id="container">
			<div class="top_module">
				<div class="title_box">
					<div class="title_content" @click="fnSelectEstate()">
						<div class="icon_font icon_addr"></div>
						<div class="title_text">{{sqmc}} {{estateName}}</div>
						<div class="icon_font icon_down"></div>
					</div>
					<div class="title_content">
						<div class="icon_font"></div>
						<div class="title_text">欢迎您！</div>
					</div>
					<div class="back_home" id="backId" @click="fnGoBack();"></div>
				</div>
				<div class="swiper_box" id="swiperId">
					<div class="swiper-wrapper">
						<div class="swiper-slide banner_1"></div>
						<div class="swiper-slide banner_2"></div>
						<div class="swiper-slide banner_3"></div>
					</div>
					<!-- Add Pagination -->
					<div class="swiper-pagination"></div>
				</div>
				<div class="big_menu">
					<div class="menu_item" onclick="fnOpenGrid();">
						<div class="icon_menu icon_menu_0"></div>
						<div class="menu_text">
							网格员
						</div>
					</div>
					<div class="menu_item" onclick="fnOpenService();">
						<div class="icon_menu icon_menu_1"></div>
						<div class="menu_text">
							便民服务
						</div>
					</div>
					<div class="menu_item" onclick="fnOpenAdvince();">
						<div class="icon_menu icon_menu_2"></div>
						<div class="menu_text">
							投诉建议
						</div>
					</div>
					<div class="menu_item" onclick="fnOpenPeoples();">
						<div class="icon_menu icon_menu_3"></div>
						<div class="menu_text">
							居民信息
						</div>
					</div>
				</div>
				<div class="big_menu">
					<div class="menu_item" onclick="fnOpenVolunteer();">
						<div class="icon_menu icon_menu_4"></div>
						<div class="menu_text">
							志愿者
						</div>
					</div>
					<div class="menu_item" onclick="fnOpenOnDuty();">
						<div class="icon_menu icon_menu_5"></div>
						<div class="menu_text">
							值班表
						</div>
					</div>
					<div class="menu_item" onclick="fnOpenQzdj();">
						<div class="icon_menu icon_menu_6"></div>
						<div class="menu_text">
							求职登记
						</div>
					</div>
					<div class="menu_item" onclick="fnOpenGzh();">
						<div class="icon_menu icon_menu_7"></div>
						<div class="menu_text">
							公众号
						</div>
					</div>
				</div>
				<div class="big_menu">
					<div class="menu_item" onclick="fnOpenVolunteerDuty();">
						<div class="icon_menu icon_menu_8"></div>
						<div class="menu_text">
							志愿者值班表
						</div>
					</div>
					<!-- <div class="menu_item" onclick="fnOpenHealthCard();"> -->
					<div class="menu_item">
						<div class="icon_menu"></div>
						<div class="menu_text">
							<!-- 健康卡 -->
						</div>
					</div>
					<div class="menu_item">
						<div class="icon_menu"></div>
						<div class="menu_text">
						</div>
					</div>
					<div class="menu_item">
						<div class="icon_menu"></div>
						<div class="menu_text">
						</div>
					</div>
				</div>
			</div>
			<div class="split_line"></div>
			<div class="msg_module" @click="fnOpenNotice()">
				<div class="icon_msg"></div>
				<div class="msg_text line_ellipsis">
					{{newNotice.BT}}
					<span class="icon_new"></span>
				</div>
				<div class="icon_right"></div>
			</div>
			<div class="split_line"></div>
			<div class="estate_module">
				<div class="estate_title line_ellipsis">
					小区简介<span class="data_uptime">{{yqData.FBRQ_}}防控日报|数据截止{{yqData.FBSJ_}}</span>
				</div>
				<div class="info_box">
					<div class="box_title">
						<div class="icon_item"></div>
						<div class="item_text">小区疫情</div>
						<div class="icon_data"></div>
					</div>
					<div class="data_boxs">
						<div class="data_box">
							<div class="item_col_name">确诊病例</div>
							<div class="item_col_data">{{yqData.QZBL}}</div>
							<div class="item_col_change">较昨日+0</div>
						</div>
						<div class="data_box">
							<!-- <div class="item_col_name">疑似病例</div> -->
							<div class="item_col_name">返汉人员</div>
							<div class="item_col_data data_color_1">{{yqData.YSBL}}</div>
							<div class="item_col_change">较昨日+0</div>
						</div>
						<div class="data_box">
							<!-- <div class="item_col_name">治愈病例</div> -->
							<div class="item_col_name">密切接触</div>
							<div class="item_col_data data_color_2">{{yqData.ZYBL}}</div>
							<div class="item_col_change">较昨日+0</div>
						</div>
					</div>
				</div>
				<div class="info_box">
					<div class="box_title">
						<div class="icon_item"></div>
						<div class="item_text">住户信息</div>
						<div class="icon_data"></div>
					</div>
					<div class="data_boxs data_boxs_1">
						<div class="data_box">
							<div class="item_col_name">楼栋数</div>
							<div class="item_col_data">{{userData.LDSL}}</div>
						</div>
						<div class="data_box">
							<div class="item_col_name">住户</div>
							<div class="item_col_data data_color_1">{{userData.ZHSL}}</div>
						</div>
						<div class="data_box">
							<!-- <div class="item_col_name">外来人员</div> -->
							<div class="item_col_name">单元</div>
							<div class="item_col_data data_color_2">{{userData.WLRL}}</div>
						</div>
					</div>
					<div class="data_boxs data_boxs_2">
						<div class="data_box">
							<!-- <div class="item_col_name">隔离人员</div> -->
							<div class="item_col_name">现住户</div>
							<div class="item_col_data data_color_3">{{userData.GLSL}}</div>
						</div>
						<div class="data_box">
							<!-- <div class="item_col_name">解除隔离人员</div> -->
							<div class="item_col_name">现住人数</div>
							<div class="item_col_data data_color_4">{{userData.JCGL}}</div>
						</div>
						<div class="data_box">
							<div class="item_col_name"></div>
							<div class="item_col_data"></div>
						</div>
					</div>
				</div>
			</div>
			<template v-if="key == 1">
				<div class="split_line"></div>
				<div class="msg_module" onclick="fnOpenXwfbInfo()">
					<div class="icon_msg"></div>
					<div class="msg_text line_ellipsis">
						新闻发布
					</div>
					<div class="icon_right"></div>
				</div>
				<div class="split_line"></div>
				<div class="msg_module" onclick="fnOpenYqfbInfo()">
					<div class="icon_msg"></div>
					<div class="msg_text line_ellipsis">
						疫情发布
					</div>
					<div class="icon_right"></div>
				</div>
				<div class="split_line"></div>
				<div class="msg_module" onclick="fnOpenSqtjInfo()">
					<div class="icon_msg"></div>
					<div class="msg_text line_ellipsis">
						社区人员统计信息发布
					</div>
					<div class="icon_right"></div>
				</div>
			</template>
			<div class="split_line"></div>
		</div>
		<script type="text/javascript" src="../js/url.js" charset="utf-8"></script>
		<script type="text/javascript" src="../js/vue.js" charset="utf-8"></script>
		<script type="text/javascript" src="../js/date.js" charset="utf-8"></script>
		<script type="text/javascript" src="../js/swiper.min.js" charset="utf-8"></script>
		<script type="text/javascript" src="../js/jquery-1.12.4-min.js" charset="utf-8"></script>
		<script type="text/javascript" src="../js/common.js" charset="utf-8"></script>
		<script type="text/javascript" src="../js/fastclick.js" charset="utf-8"></script>
		<script type="text/javascript">
			$(function() {
				FastClick.attach(document.body);
			})
		</script>
		<script type="text/javascript" src="../js/jqweui/jquery-weui.min.js" charset="utf-8"></script>
		<script type="text/javascript" src="../js/city-picker.js" charset="utf-8"></script>
		<script type="text/javascript" src="../js/iosSelect.js" charset="utf-8"></script>
		<script type="text/javascript" src="../js/iosSelect/select2.option.js?v=1" charset="utf-8"></script>
		<script type="text/javascript">
			// 初始化双向绑定模型
			var vue = new Vue({
				el: '#container',
				data: {
					key: 0,
					estateId: '',
					estateName: '',
					sqbm: '',
					sqmc: '',
					newNotice: {
						BT: '',
						LJ: ''
					},
					userData: {
						ldsl: 0,//楼栋数量
						zhsl: 0,//住户数量
						wlrl: 0,//单元数量
						glsl: 0,//现住户数量
						jcgl: 0,//现住人数量
						xqsl: 0,//小区数量
						UpdateTime: "2020-03-09 14:43:34",
						fbrq_: '',
						fbsj_:''
					},
					yqData: {
						fbrq: "2020-03-12 11:17:00",//最新发布日期
						qzbl: 0,//确诊病例
						swbl: 0,//确诊接触人数
						ysbl: 0,//返汉人员数量
						zybl: 0,//密切接触人数
						xqsl: 0,//小区数量
						fbrq_: '',
						fbsj_:''
					}
					
				},
				methods: {
					fnOpenNewNotice: fnOpenNewNotice,
					fnOpenNotice: fnOpenNotice,
					fnSelectEstate: fnSelectEstate,
					fnGoBack: fnGoBack
				}
			});
			
			var swiper = new Swiper('#swiperId', {
				pagination: '.swiper-pagination',
				autoplay: 3000, //可选选项，自动滑动
				paginationClickable: true
			});
			// 小区编码，小区名称，社区名称
			var estateId, estateName, sqmc;
			var estateNameFlag = false;
			$(function() {
				key = fnGetQueryString("key");
				if(key != undefined && key == 1){
					vue.$data.key = 1;
				} else {
				}
				var zhlx = window.localStorage.getItem("zhlx");
				console.log("=== === >> :"+zhlx);
				if(zhlx != undefined && (zhlx == '街道办' || zhlx == '社区')){
					
				} else {
					$("#backId").hide();
				}
				estateId = fnGetQueryString("estateId");
				estateName = fnGetQueryString("estateName");
				sqmc = fnGetQueryString("sqmc");
				if(estateName != undefined && estateName != ""){
					estateNameFlag = true;
					vue.$data.estateId = decodeURI(estateId);
					vue.$data.estateName = decodeURI(estateName);
					vue.$data.sqmc = decodeURI(sqmc);
					// 记录并刷新数据
					window.localStorage.setItem("estateId", vue.$data.estateId);
					window.localStorage.setItem("estateName", vue.$data.estateName);
					window.localStorage.setItem("sqmc", vue.$data.sqmc);
				}
				// 获取最新社区公告
				fnGetNoticeInfo();
				// 获取辖区内小区列表信息
				fnGetEstateList();
			});
			
			// 返回管委会
			function fnGoBack(){
				window.top.history.back();
			}

			// 打开网格员页面
			function fnOpenGrid() {
				window.location.href = "./grid_info.html?date="+new Date().getTime();
			}
			
			// 打开便民服务页面
			function fnOpenService() {
				window.location.href = "./service_info.html?date="+new Date().getTime();
			}
			
			// 打开投诉建议页面
			function fnOpenAdvince() {
				window.location.href = "./advince_frm.html?date="+new Date().getTime();
			}

			// 打开居民信息页面
			function fnOpenPeoples() {
				if(vue.$data.key == 1){
					// 打开居民统计信息页面
					window.location.href = "./peoples_info2.html?date="+new Date().getTime();
				} else {
					// 打开居民填报页面
					// window.location.href = "http://59.108.92.198:9006/NewApp/AutoFormMobile/Edit?configId=jmxxdc";
					window.location.href = "./publish_frm.html?type=4";
				}
			}

			// 打开社区公告页面
			function fnOpenNotice() {
				window.location.href = "./notice_info.html?date="+new Date().getTime();
			}
			
			// 打开社区公告最新信息详情页面
			function fnOpenNewNotice(link){
				if(link == '')
					return;
				if(link.startsWith("http")){
					window.location.href = link;
				} else {
					window.location.href = "./notice_detail.html?link="+link;
				}
			}
			
			// 打开新闻发布页面
			function fnOpenXwfbInfo(){
				window.location.href = "./publish_frm.html?type=1";
			}
			
			// 打开疫情发布页面
			function fnOpenYqfbInfo(){
				window.location.href = "./publish_frm.html?type=2";
			}
			
			// 打开社区人员统计信息发布页面
			function fnOpenSqtjInfo(){
				window.location.href = "./publish_frm.html?type=3";
			}

			// 打开志愿者页面
			function fnOpenVolunteer(){
				window.location.href = "./volunteer_info.html";
			}
			
			// 打开值班表页面
			function fnOpenOnDuty(){
				window.location.href = "./on_duty_info.html?date="+new Date().getTime();
			}
			
			// 打开求职登记页面
			function fnOpenQzdj(){
				window.location.href = "./publish_frm.html?type=5";
			}
			
			// 打开公众号页面
			function fnOpenGzh(){
				window.location.href = "./wx_public_account.html";
			}
			
			// 打开志愿者值班表页面
			function fnOpenVolunteerDuty(){
				window.location.href = "./vol_duty_info.html?date="+new Date().getTime();
			}
			
			// 打开健康卡页面
			function fnOpenHealthCard(){
				window.location.href = "./vol_duty_info.html?date="+new Date().getTime();
			}
			
			// 获取社区公告信息
			function fnGetNoticeInfo() {
				$.showLoading();
				var url = mHost + mServerName + "/SQGL/getLastSQXW";
				var params = {
					page: 1,
					row: 1,
					xq: '' // 小区名称
				}
				console.log("=== === >> 参数：" + JSON.stringify(params));
				$.ajax({
					type: "get",
					url: url,
					contentType: 'application/x-www-form-urlencoded',
					data: params,
					dataType: "jsonp",
					success: function(result) {
						$.hideLoading();
						if (result.state != undefined && result.state == true) {
							var data = result.lastxw;
							vue.$data.newNotice = data;
						} else {
							// 失败
							$.toast("失败！", 'cancel');
						}
					},
					error: function(jqXHR, textStatus) {
						$.hideLoading();
						$.toast("服务异常！", 'cancel')
					}
				});
			}
			
			// 获取社区住户统计信息
			function fnGetEstateData(){
				$.showLoading();
				var url = mHost + mServerName + "/SQGL/getSQRYTJ";
				var params = {
					sqmc: vue.$data.sqmc,
					xqbm: vue.$data.estateId,
					xqmc: vue.$data.estateName
				}
				console.log("=== === >> 参数：" + JSON.stringify(params));
				$.ajax({
					type: "get",
					url: url,
					contentType: 'application/x-www-form-urlencoded',
					data: params,
					dataType: "jsonp",
					success: function(result) {
						$.hideLoading();
						if (result.state != undefined && result.state == true) {
							var data = result.lastZh;
							vue.$data.userData = data;
							if(!estateNameFlag){
								vue.$data.estateName = data.XQMM;
							}
						} else {
							// 失败
							$.toast("失败！", 'cancel');
						}
					},
					error: function(jqXHR, textStatus) {
						$.hideLoading();
						$.toast("服务异常！", 'cancel')
					}
				});
			}
			
			// 获取社区疫情数据
			function fnGetYQData(){
				$.showLoading();
				var url = mHost + mServerName + "/SQGL/getYQTJ";
				var params = {
					sqmc: vue.$data.sqmc,
					xqbm: vue.$data.estateId,
					xqmc: vue.$data.estateName
				}
				console.log("=== === >> 参数：" + JSON.stringify(params));
				$.ajax({
					type: "get",
					url: url,
					contentType: 'application/x-www-form-urlencoded',
					data: params,
					dataType: "jsonp",
					success: function(result) {
						$.hideLoading();
						if (result.state != undefined && result.state == true) {
							var data = result.lastYq;
							var fbrq = data.FBRQ;
							FBRQ_ = new Date().Format("yyyy年MM月dd日");
							FBSJ_ = "00:00";
							if(fbrq != undefined && fbrq != ''){
								FBRQ_ = new Date(fbrq).Format("MM月dd日");
								FBSJ_ = new Date(fbrq).Format("hh:mm");
							}
							data.FBRQ_ = FBRQ_;
							data.FBSJ_ = FBSJ_;
							vue.$data.yqData = data;
						} else {
							// 失败
							$.toast("失败！", 'cancel');
						}
					},
					error: function(jqXHR, textStatus) {
						$.hideLoading();
						$.toast("服务异常！", 'cancel')
					}
				});
			}
			
			// 获取小区信息
			function fnGetEstateList(){
				$.showLoading();
				var url = mHost + mServerName + "/SQGL/getXiaoQuAndSqList";
				var params = {
					// xzqhdm: '110110'
					sqbm: vue.$data.sqbm
				}
				console.log("=== === >> 参数：" + JSON.stringify(params));
				$.ajax({
					type: "get",
					url: url,
					contentType: 'application/x-www-form-urlencoded',
					data: params,
					dataType: "jsonp",
					success: function(result) {
						$.hideLoading();
						console.log("=== === >> 获取结果："+JSON.stringify(result))
						if (result.state != undefined && result.state == true) {
							// 处理社区数据
							var sqData = result.sqList;
							firstOptions = [];
							for(var i=0; i<sqData.length; i++){
								var item = sqData[i];
								var c = {'id': item.ID, 'value': item.sqmc, 'parentId': '0'}
								firstOptions.push(c);
							}
							// 处理小区数据
							var xqData = result.xqList;
							secondOptions = [];
							for(var i=0; i<xqData.length; i++){
								var item = xqData[i];
								var c = {'id': item.ID, 'value': item.xqmc, 'parentId': item.sssqid}
								secondOptions.push(c);
							}
							if(vue.$data.key == 0){
								// 居民登录
								var estateId_ = window.localStorage.getItem("estateId");
								if(estateId_ == undefined || estateId_ == ""){
									// 提示选择小区
									fnSelectEstate();
								} else {
									var estateName_ = window.localStorage.getItem("estateName");
									var sqmc_ = window.localStorage.getItem("sqmc");
									vue.$data.estateId = estateId_;
									vue.$data.estateName = estateName_;
									vue.$data.sqmc = sqmc_;
									estateNameFlag = true;
									// 获取社区住户统计信息
									fnGetEstateData();
									// 获取社区疫情数据
									fnGetYQData();
								}
							} else {
								// 管理员登录 TODO
								var estateId_ = window.localStorage.getItem("estateId");
								if(estateId_ == undefined || estateId_ == ""){
									// 提示选择小区
									fnSelectEstate();
								} else {
									var estateName_ = window.localStorage.getItem("estateName");
									var sqmc_ = window.localStorage.getItem("sqmc");
									vue.$data.estateId = estateId_;
									vue.$data.estateName = estateName_;
									vue.$data.sqmc = sqmc_;
									estateNameFlag = true;
									// 获取社区住户统计信息
									fnGetEstateData();
									// 获取社区疫情数据
									fnGetYQData();
								}
							}
						} else {
							// 失败
							$.toast("失败！", 'cancel');
						}
					},
					error: function(jqXHR, textStatus) {
						$.hideLoading();
						$.toast("服务异常！", 'cancel')
					}
				});
			}
			
			// 选择社区
			function fnSelectEstate(){
				if(vue.$data.key == 1){
					// return;
				}
				setTimeout(function(){
					oneOptionId = vue.$data.sqbm;
					twoOptionId = vue.$data.estateId;
					getOptionId(oneOptionId, twoOptionId, function(checkOption) {
						estateNameFlag = true;
						vue.$data.sqbm = checkOption.firstOptionId;
						vue.$data.sqmc = checkOption.firstOptionName;
						vue.$data.estateId = checkOption.secondOptionId;
						vue.$data.estateName = checkOption.secondOptionName;
						// 记录并刷新数据
						window.localStorage.setItem("sqbm", vue.$data.sqbm);
						window.localStorage.setItem("sqmc", vue.$data.sqmc);
						window.localStorage.setItem("estateId", vue.$data.estateId);
						window.localStorage.setItem("estateName", vue.$data.estateName);
						// 获取选中小区的数据
						// 1、获取社区住户统计信息
						fnGetEstateData();
						// 2、获取社区疫情数据
						fnGetYQData();
					}, function(){
						// 取消回调
						if(vue.$data.estateId == ''){
							$.toast("请选择小区！", 'cancel');
							fnSelectEstate();
						}
					});
				}, 500);
			}
		</script>
	</body>
</html>
